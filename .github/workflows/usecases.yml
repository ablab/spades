name: SPAdes usecases

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  BUILD_DIR: ${{github.workspace}}/build
  INSTALL_DIR: ${{github.workspace}}/spades
  SRC_DIR: ${{github.workspace}}/assembler/src
  PKG: SPAdes-3.16.0-dev-Linux

jobs:
  build:
    runs-on: self-hosted
    name: 'ðŸš§ Build SPAdes'

    steps:
      - name: 'ðŸ§¹ Cleanup'
        run: >
          set -e &&
          shopt -s dotglob &&
          rm -rf *

      - name: 'ðŸ§° Checkout'
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: 'âš™ï¸ Install ccache'
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          variant: sccache

      - name: 'âš™ï¸ Configure CMake'
        run: >
          cmake
          -B ${{env.BUILD_DIR}}
          -S ${{env.SRC_DIR}}
          -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
          -DCMAKE_INSTALL_PREFIX=${{env.INSTALL_DIR}}

      - name: 'ðŸš§ Build'
        run: >
          cmake
          --build ${{env.BUILD_DIR}}
          -j16
          -t package

      - name: 'ðŸ“¦ Package'
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            ${{env.BUILD_DIR}}/${{env.PKG}}.tar.gz

  mc-bcereus-truseq-100x:
    name: 'Multicell B.cereus TruSeq 100x.'
    runs-on: self-hosted
    needs: build

    steps:
      - name: 'ðŸ§¹ Cleanup'
        run: >
          set -e &&
          shopt -s dotglob &&
          rm -rf *

      - name: 'ðŸ§° Checkout'
        uses: actions/checkout@v3
        with:
          fetch-depth: 1          
      - name: 'ðŸ“¦ Download package'
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: ${{env.INSTALL_DIR}}
      - name: 'ðŸ“¦ Unpack package'
        working-directory: ${{env.INSTALL_DIR}}
        run: >
          tar -zxf ${{env.PKG}}.tar.gz
      - name: 'Assembly'
        run: >
          ${{env.SRC_DIR}}/test/teamcity/github_runner.py
          --spades_path ${{env.INSTALL_DIR}}/${{env.PKG}}/bin
          --no_contig_archive
          /data/pipeline_tests/Multicell_B.cereus_TruSeq_100x.info
          
  nextera-lmonocytogenes:
    name: 'Nextera L.monocytogenes'
    runs-on: self-hosted
    needs: build

    steps:
      - name: 'ðŸ§¹ Cleanup'
        run: >
          set -e &&
          shopt -s dotglob &&
          rm -rf *

      - name: 'ðŸ§° Checkout'
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - name: 'ðŸ“¦ Download package'
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: ${{env.INSTALL_DIR}}
      - name: 'ðŸ“¦ Unpack package'
        working-directory: ${{env.INSTALL_DIR}}
        run: >
          tar -zxf ${{env.PKG}}.tar.gz
      - name: 'Assembly'
        run: >
          ${{env.SRC_DIR}}/test/teamcity/github_runner.py
          --spades_path ${{env.INSTALL_DIR}}/${{env.PKG}}/bin
          --no_contig_archive
          /data/pipeline_tests/Nextera_L.monocytogenes.info
