name: SPAdes release snapshot

on:
  workflow_dispatch:
  push:
    tags:
      - '*'
    paths-ignore:
      - 'docs/**'

env:
  INSTALL_DIR: ${{github.workspace}}/spades
  PKG: SPAdes-*-Linux

jobs:
  # We build inside a ManyLinux container, but run checks outside
  build:
    runs-on: self-hosted
    container: quay.io/pypa/manylinux_2_28_x86_64
    name: '🚧 Build SPAdes inside ManyLinux 2.28 container'

    env:
      BUILD_TYPE: Release
      BUILD_DIR: './build'
      SRC_DIR: './src'

    steps:
      - name: '🧹 Cleanup'
        run: >
          set -e &&
          shopt -s dotglob &&
          rm -rf *

      - name: '🧰 Checkout'
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: '⚙️ Install ccache'
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          variant: sccache
          key: sccache-${{env.BUILD_TYPE}}

      - name: '⚙️ Configure CMake'
        run: >
          cmake
          -B $BUILD_DIR
          -S $SRC_DIR
          -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: '🚧 Build'
        run: >
          cmake
          --build $BUILD_DIR
          -j16
          -t package

      - name: '📦 Package'
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            $BUILD_DIR/$PKG.tar.gz

  spades-1k-checks:
    name: 'E. coli 1k smoke checks'
    runs-on: self-hosted
    needs: build

    steps:
      - name: '🧹 Cleanup'
        run: >
          set -e &&
          shopt -s dotglob &&
          rm -rf *

      - name: '📦 Download package'
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: ${{env.INSTALL_DIR}}

      - name: '📦 Unpack package'
        working-directory: ${{env.INSTALL_DIR}}
        run: >
          tar -zxf ${{env.PKG}}.tar.gz

      - name: '1k multi-cell'
        run: >
          $INSTALL_DIR/$PKG/bin/spades.py --test

      - name: '1k single-cell'
        run: >
          $INSTALL_DIR/$PKG/bin/spades.py --sc --test

      - name: '1k meta'
        run: >
          $INSTALL_DIR/$PKG/bin/metaspades.py --test

      - name: '1k plasmid'
        run: >
          $INSTALL_DIR/$PKG/bin/plasmidspades.py --test

      - name: '1k rna'
        run: >
          $INSTALL_DIR/$PKG/bin/rnaspades.py --test

      - name: '1k corona'
        run: >
          $INSTALL_DIR/$PKG/bin/coronaspades.py --test
