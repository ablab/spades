#!/bin/bash

function run_n_measure
{
   if [ "$(uname -s)" == "Darwin" ]; then # Mac OS X
       /usr/bin/time $1 $2 $3 $4 $5 $6 $7
   else # other, e.g. Linux
       /usr/bin/time -f "\n\ntime: %E" $1 $2 $3 $4 $5 $6 $7
   fi
}

function change_config
{
    ds_folder='configs/debruijn/datasets/'
    dsa_folder='configs/debruijn/datasets_archive/'
    
    ds_folder_prefix=${ds_folder//\//\\\/}
    dsa_folder_prefix=${dsa_folder//\//\\\/}

    ls $ds_folder | sed -e "s/^/$ds_folder_prefix/" > temp
    ls $dsa_folder | sed -e "s/^/$dsa_folder_prefix/" >> temp
    
    #awk '/\{/ {print str} {str = $1}' configs/debruijn/datasets.info > temp
    #awk '/\{/ {print str} {str = $1}' configs/debruijn/datasets_archive.info >> temp

# firstly exact match

    dataset="`grep -w $1 temp`"
    if [ "{$dataset" == "{" ]; then
        dataset="`grep $1 temp`"
    fi
    if [ "{$dataset" == "{" ]; then
        echo "No dataset for you!"
        #rm temp
        exit
    fi
    if [ ` echo "$dataset" | sed -n '$='` == 1 ]; then
        echo "$dataset dataset chosen"
        awk -v ds=$dataset '{if ($1 == "dataset") print "dataset","\t",ds; else print $0}' configs/debruijn/config.info  > config.info
        mv config.info configs/debruijn/config.info
    else
        echo "Dataset ambiguous :"
        echo "$dataset"
        echo "The first one will be chosen :"
        dataset=`echo $dataset | awk '{print $1}' `
        echo "$dataset"
        awk -v ds=$dataset '{if ($1 == "dataset") print "dataset","\t",ds; else print $0}' configs/debruijn/config.info  > config.info
        mv config.info configs/debruijn/config.info
    fi

    rm temp
}

if [ $# = 0 ]
then
    run_n_measure build/release/debruijn/debruijn configs/debruijn/config.info 
else 
case $1 in

'rd' ) run_n_measure build/release/debruijn/debruijn configs/debruijn/config.info ;;
'dd' ) run_n_measure build/debug/debruijn/debruijn configs/debruijn/config.info ;;
'ddt' ) run_n_measure build/debug/test/debruijn/debruijn_test ;;
'rdt' ) run_n_measure build/release/test/debruijn/debruijn_test ;;
'ddtls' ) run_n_measure build/debug/test/debruijn_tools/debruijn_tools ;;
'rdtls' ) run_n_measure build/release/test/debruijn_tools/debruijn_tools ;;
'dit' ) run_n_measure build/debug/test/include_test/include_test ;;
'dt') run_n_measure build/debug/test/debruijn/debruijn_test && run_n_measure build/debug/test/include_test/include_test ;;

* ) 
    change_config $1

    run_n_measure build/release/debruijn/debruijn configs/debruijn/config.info ;;
#    run_n_measure $1 $2 $3 $4 $5 
esac
fi


